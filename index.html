<!DOCTYPE html>
<html>
<head>
  <title>Visit Report Form - Refco India</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <style>
    body { background: #f5f5f5; padding: 20px; }
    .form-container { max-width: 700px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
  </style>
</head>
<body>
  <div class="form-container">
    <h3 class="mb-4">Visit Report Submission</h3>
    <form id="visitForm">
      <div class="mb-3">
        <label for="company" class="form-label">Company Name</label>
        <input type="text" class="form-control" id="company" required>
      </div>
      <div class="mb-3">
        <label for="contact" class="form-label">Contact Person</label>
        <input type="text" class="form-control" id="contact" required>
      </div>
      <div class="mb-3">
        <label for="material" class="form-label">Material Requirement</label>
        <select class="form-select" id="material" required>
          <option value="">Select</option>
          <option>ACID RESISTANT MATERIALS</option>
          <option>REFRACTORY MATERIALS</option>
          <option>INDUSTRIAL FLOORING TILES</option>
          <option>EPOXY COATINGS</option>
          <option>ACID RESISTANT AND REFRACTORY MATERIALS</option>
        </select>
      </div>
      <div class="mb-3">
        <label class="form-label">Attach Visiting Card</label>
        <input type="file" class="form-control" id="visitingCard" accept="image/*" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Location (auto-detected)</label>
        <input type="text" class="form-control" id="location" readonly>
      </div>
      <div class="mb-3">
        <label class="form-label">Staff Email</label>
        <input type="email" class="form-control" id="staffEmail" readonly>
      </div>
      <button type="submit" class="btn btn-primary">Submit Report</button>
      <a href="https://docs.google.com/spreadsheets/d/1MyhXOfpmSC4m4LcyMEI__vj8DKuV3vksz6Re4r3uYuY/edit#gid=0" target="_blank" class="btn btn-secondary ms-2">View Past Submissions</a>
    </form>
    <div id="message" class="alert alert-success mt-3 d-none">Report submitted successfully!</div>
  </div>

  <script>
    // Geo-location fetch
    navigator.geolocation.getCurrentPosition(pos => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      document.getElementById('location').value = `https://maps.google.com/?q=${lat},${lon}`;
    });

    // Google Sign-in to get email
    google.accounts.id.initialize({
      client_id: "87025893302-tjlhqrts2vubbv0bt82ue9u2vtfvnfg0.apps.googleusercontent.com",
      callback: response => {
        const jwt = JSON.parse(atob(response.credential.split('.')[1]));
        document.getElementById('staffEmail').value = jwt.email;
      }
    });
    google.accounts.id.prompt();

    // Submit handler
    document.getElementById('visitForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const file = document.getElementById('visitingCard').files[0];
      const formData = new FormData();
      formData.append("company", document.getElementById('company').value);
      formData.append("contact", document.getElementById('contact').value);
      formData.append("material", document.getElementById('material').value);
      formData.append("location", document.getElementById('location').value);
      formData.append("staffEmail", document.getElementById('staffEmail').value);
      formData.append("visitingCard", file);
      await fetch("https://script.google.com/macros/s/YOUR_DEPLOYED_SCRIPT_URL/exec", {
        method: 'POST',
        body: formData
      });
      document.getElementById('message').classList.remove('d-none');
      document.getElementById('visitForm').reset();
    });
  </script>
</body>
</html>
