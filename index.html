<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Visit Report Submission</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
  <div class="max-w-xl mx-auto mt-10 bg-white p-8 rounded shadow">
    <h1 class="text-2xl font-bold mb-6">Visit Report Submission</h1>

    <form id="visitForm">
      <div class="space-y-4">
        <input type="text" placeholder="Company Name" id="companyName" class="w-full p-2 border rounded" required>
        <input type="text" placeholder="Contact Person" id="name" class="w-full p-2 border rounded" required>
        <input type="tel" placeholder="Mobile" id="mobile" class="w-full p-2 border rounded" required>
        <input type="email" placeholder="Email" id="email" class="w-full p-2 border rounded" required>
        <input type="text" placeholder="Address" id="address" class="w-full p-2 border rounded" required>
        <input type="text" placeholder="City" id="city" class="w-full p-2 border rounded" required>
        <input type="text" placeholder="State" id="state" class="w-full p-2 border rounded" required>
        <input type="text" placeholder="Pin Code" id="pincode" class="w-full p-2 border rounded" required>

        <select id="materialRequired" class="w-full p-2 border rounded" required>
          <option value="">Select Material Required</option>
          <option value="ACID RESISTANT MATERIALS">ACID RESISTANT MATERIALS</option>
          <option value="REFRACTORY MATERIALS">REFRACTORY MATERIALS</option>
          <option value="INDUSTRIAL FLOORING TILES">INDUSTRIAL FLOORING TILES</option>
          <option value="EPOXY COATINGS">EPOXY COATINGS</option>
          <option value="ACID RESISTANT AND REFRACTORY MATERIALS">ACID RESISTANT AND REFRACTORY MATERIALS</option>
        </select>

        <input type="file" id="visitingCard" accept="image/*" capture="environment" class="w-full p-2 border rounded" required>

        <textarea placeholder="About Requirement / Remarks" id="remarks" class="w-full p-2 border rounded"></textarea>

        <input type="text" id="location" placeholder="Auto-detected location" class="w-full p-2 border rounded bg-gray-100" readonly>

        <input type="email" placeholder="Staff Email" id="staffEmail" class="w-full p-2 border rounded" required>

        <div class="flex justify-between space-x-4">
          <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Submit Report</button>
          <a href="https://docs.google.com/spreadsheets/d/1tNG36MCxQK3jeqzFT9AMbEdybpFHdexiAGt2ZBRXMu4/edit?usp=sharing" target="_blank" class="bg-gray-600 text-white px-4 py-2 rounded">View Past Submissions</a>
        </div>
      </div>
    </form>

    <p id="status" class="mt-4 text-red-600"></p>
  </div>

  <script>
    const form = document.getElementById("visitForm");
    const locationField = document.getElementById("location");
    const status = document.getElementById("status");

    // Auto-detect location
    navigator.geolocation.getCurrentPosition(pos => {
      const { latitude, longitude } = pos.coords;
      const mapUrl = `https://maps.google.com/?q=${latitude},${longitude}`;
      locationField.value = mapUrl;
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const fileInput = document.getElementById("visitingCard");
      const file = fileInput.files[0];

      if (!file) {
        status.textContent = "Please attach a visiting card.";
        return;
      }

      const reader = new FileReader();
      reader.onloadend = async () => {
        const formData = {
          companyName: document.getElementById("companyName").value,
          name: document.getElementById("name").value,
          mobile: document.getElementById("mobile").value,
          email: document.getElementById("email").value,
          address: document.getElementById("address").value,
          city: document.getElementById("city").value,
          state: document.getElementById("state").value,
          pincode: document.getElementById("pincode").value,
          materialRequired: document.getElementById("materialRequired").value,
          remarks: document.getElementById("remarks").value,
          location: document.getElementById("location").value,
          staffEmail: document.getElementById("staffEmail").value,
          visitingCardURL: reader.result, // base64 encoded
        };

        try {
          const response = await fetch("https://script.google.com/macros/s/AKfycbzVyY00qej6eEYikbspTJ4d_YNPs65Tdy6K-AF4pCkYYtrjv2biNiJ0fXA05KVqAfhW/exec", {
            method: "POST",
            body: JSON.stringify(formData),
            headers: {
              "Content-Type": "application/json",
            },
          });

          const result = await response.json();
          if (result.result === "success") {
            status.textContent = "✅ Submission successful!";
            form.reset();
          } else {
            status.textContent = "❌ Submission failed: " + result.message;
          }
        } catch (error) {
          status.textContent = "❌ Submission failed. Try again.";
          console.error(error);
        }
      };

      reader.readAsDataURL(file);
    });
  </script>
</body>
</html>
